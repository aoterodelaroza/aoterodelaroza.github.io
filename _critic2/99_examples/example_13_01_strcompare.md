---
layout: single
title: "Compare molecular and crystal structures"
permalink: /critic2/examples/example_13_01_strcompare/
excerpt: "Compare molecular and crystal structures"
sidebar:
  - repo: "critic2"
    nav: "critic2_examples"
toc: true
toc_label: "Compare molecular and crystal structures"
---

# VC-PWDF walk-through

## Overview
The VC-PWDF method is a protocol that compares two crystal structures and yields a numerical value that is
related to the similarity of the two structures being compared. The protocol uses the simulated powder
diffractograms of the two structures in order to yield a dissimilarity value using a cross-correlation
function (ie. a measure of peak overlap,
[J. Comput. Chem., 2001, 22, 273](https://doi.org/10.1002/1096-987X(200102)22:3%3C273::AID-JCC1001%3E3.0.CO;2-0)). The value yielded by the method
is a number between 0 (identical) and 1 (completely dissimilar). We have called this value the "VC-PWDF score",
and a score \< 0.03 indicates considerable similarity and a probable match; however, user discretion is
recommended regarding a cutoff for classifying a "match". The protocol is specifically
designed to be highly effective for the comparison of crystal structures obtained under different conditions;
low/high temperatures, high pressure, or in silico-generated by force field/MM or electronic structure
theory/DFT computational methods.

Details on the development, abilities, and applications (identification of target crystal structures in CSP
landscapes [CrystEngComm, 2021, 23, 7118](https://pubs.rsc.org/en/content/articlehtml/2021/ce/d1ce01058a),
distinguishing the same structure from polymorph structures in the
CSD [CrystEngComm, 2022, 24, 8326](https://pubs.rsc.org/en/content/articlehtml/2022/ce/d2ce01080a),
matching experimental PXRD to crystal structures
 [Chem. Sci., 2023](https://pubs.rsc.org/en/content/articlehtml/2023/sc/d3sc00168g)) are
provided elsewhere.

If you find the VC-PWDF method useful, please cite:
- R.A. Mayo, A. Otero de la Roza, and E.R. Johnson, _CrystEngComm_, **2022**, _24_, 8326-8338.

If you find the VC-xPWDF method useful, please cite:
- R.A. Mayo, K.M. Marczenko, and E.R. Johnson, _Chem. Sci._, **2023**, https://doi.org/10.1039/D3SC00168G.

In either case, please note your usage of critic2 by citing:
- A. Otero-de-la-Roza, E. R. Johnson and V. Luaña, _Comput. Phys. Commun._, **2014**, _185_, 1007-1018.
- A. Otero-de-la-Roza, M. A. Blanco, A. Martín Pendás and V. Luaña, _Comput. Phys. Commun._, **2009**, _180_, 157–166.

## Limitations
The VC-PWDF methods currently only simulate/compare powder diffractograms from Cu K&#945;<sub>1</sub>
radiation, cannot
be used reliably for disordered structures, and will yield low scores for certain polytype and conformational
phase structures. Experimental PXRD data that exhibit considerable amorphous-like baseline require pre-processing; data
that show severe preferred orientation may yield poor results.

## Prerequisits
It is expected that critic2 has been fully installed and that the user has a basic level of Linux familiarity
(read/write files, command line tools and navigation, conditional statements, for-loops). For a more
beginner-level walk-through, the [VC-(x)PWDF instruction manual](https://erin-r-johnson.github.io/software/) posted on the Johnson group web page may be useful.

## Comparing two crystal structures to obtain the VC-PWDF score
### Interactive
Start an instance of critic2 in a working directory containing the two crystal structure files you wish to
compare. The critic2 command `COMPAREVC` is used to initiate the VC-PWDF protocol to compare the two crystal
structures given (see [here](https://aoterodelaroza.github.io/critic2/manual/crystal/) for compatible crystal
structure file types):
~~~
COMPAREVC xtal1.cif xtal2.cif
~~~
The two crystal structure files that are being compared must be in the working directory, or the relative or
absolute path to the files can be given.

The printed output includes:
- which structure has been used as the refence and which has been designated the candidate structure,
- the Niggli reduced cell lattice vectors and cell dimensions,
- the list of viable lattice vectors of the candidate structure and their matching to the lattice vector(s)
of the reference structure's Niggli cell,
- the [POWDIFF](https://aoterodelaroza.github.io/critic2/manual/structure/#c2-compare) results from comparison of the reference structure to the distorted cells of the candidate
structure,
- The VC-PWDF score is the lowest POWDIFF result, printed at the very end of the output
`+ FINAL Diff = <value>`

### Input file
The critic2 commands can be written to an input file (`.cri` extension recommend) and run with critic2 non-
interactively.
~~~
critic2 input.cri
~~~
If your interest is only the VC-PWDF score, piping the output through a `grep` command can give you this value:
~~~
critic2 input.cri | grep FINAL
~~~
Simply pipe the output to a file (`.cro` extension recommended) to save it. Sending the output to be printed
into a file allows you to review the protocol run, and save the VC-PWDF score in a file to review later if
necessary.
~~~
critic2 input.cri > output.cro
~~~

## Comparing a list of structures with a target structure
If you are searching a list of structures to see if any match a reference experimental structure that you have
(eg. a CSP landscape for an experimental structure), one way to do this is to generate all the input files
with a for loop. Given the example of the following sample directory:
~~~
target.cif	xx03.cif	xx06.cif	xx09.cif	xx12.cif	xx15.cif
xx01.cif	xx04.cif	xx07.cif	xx10.cif	xx13.cif	xx16.cif
xx02.cif	xx05.cif	xx08.cif	xx11.cif	xx14.cif	xx17.cif
~~~
etc...  where the `target.cif` crystal structure is the reference experimental structure, and the `xx*.cif`
files were generated computationally, a `for` loop to make all the critic2 input files could look like this:
~~~
for i in xx*.cif ; do echo "COMPAREVC target.cif $i" > ${i%.cif}.cri ; done
~~~
which can be run from the command line. A similar `for` loop can be written to run all the new .cri files
through critic2:
~~~
for i in *.cri ; do critic2 $i > ${i%.cri}.cro ; done
~~~

If you have a couple thousand structures to compare, running the comparisons in parallel over N processors
will reduce the total time required to approximately 1/N. This can be done with [parallel](https://www.gnu.org/software/parallel/). If your list of CSP structures is
all contained within one concatenated file, [csplit](https://www.gnu.org/software/coreutils/manual/html_node/csplit-invocation.html) is ideal for creating a unique file for each structure.

Once output files have been generated, a table of results sorted by lowest VC-PWDF score can be made
with the following line:
~~~
for i in *.cro ; do echo -n "${i%.cro}   " ; grep FINAL $i | awk '{print$5}' ; done | sort -n -k2 > results.txt
~~~

## Generating a file of the distorted crystal structure
If you want to view the overlay of the two crystal structures that yield the VC-PWDF score (as a result of the
lattice deformation), add `WRITE` to the end of the command:
~~~
COMPAREVC xtal1.cif xtal2.cif WRITE
~~~

Two `.res` format files will be generated, one of each of the crystal
structures that yielded the VC-PWDF score. The crystal structure entered first after the `comparevc` command
(`xtal1.cif`) will be written
 to the file `stdin_structure_1.res`, and the second structure to `stdin_structure_2.res` (where `stdin` is
replaced by the `filename` of `filename.cri` if using an input file). Review the output information to
determine
whether `xtal1` or `xtal2` was deformed (ie. _not_ the reference). These structures can be viewed in a
GUI of
your choice, compared with other methods, etc...

## Plotting the simulated powder diffractograms
A simulated powder diffractogram can be generated for any crystal structure with critic2 by loading the
crystal structure, then entering the `POWDER` command.
~~~
crystal stdin_structure_2.res
POWDER
~~~

Two files will be generated, a sample gnuplot command file to plot the data with
[gnuplot](http://www.gnuplot.info/) `stdin_xrd.gnu`, and a two-column file of 2&#952; (°) and intensity `stdin_xrd.dat`.  Use a plotting program of your choice to plot the simulated powder patterns.

<figure style="width: 95%" class="align-center">
  <img src="{{ site.url }}{{ site.baseurl }}/assets/critic2/example_13_01/PXRD_overlay-VC.png" alt="VC-PWDF simulated PXRD overlay">
</figure>

# Comparing experimental PXRD data with a crystal structure

The VC-xPWDF method is used to compare experimentally collected powder diffractograms to the simulated powder
diffractograms from crystal structures in order to identify the matching crystal structure to the experimental
powder diffractogram. The VC-xPWDF method requires that experimental powder diffractogram be indexed, our
recommendation for accomplishing this is the [Crysfire2020 program](http://ccp14.cryst.bbk.ac.uk/Crysfire.html). A VC-xPWDF score \< 0.1 implies notable
similarity but does not guarantee a match. It is recommended to plot an overlay of the simulated powder
diffractogram of the best-matching crystal structure and the experimental data in order to confirm a match.
The VC-xPWDF method also provides an optimal starting point for the model structure if one has sufficiently
high quality PXRD data to perform Rietveld refinement. Minimal processing of the experimental PXRD data is
done within the protocol, so if there is a substantial baseline (eg. transmission mode collection), or the
instrument used to collect the data lacks a
Cu K&#945; filter, pre-processing to baseline correct and strip extraneous peaks from radiation not matching
Cu K&#945;<sub>1</sub> is highly recommended for viable results.

### Required inputs
The following are required to run a VC-xPWDF comparison
- a powder diffractogram from Cu K&#945; diffraction in `.xy` format (2&#952; (°) vs intensity)
- indexed unit cell dimensions from your experimental PXRD data
- a crystal structure you wish to compare to the PXRD data

### The VC-xPWDF command
While `COMPAREVC` is used to compare two given crystal structures, to run the VC-xPWDF method `trick compare` is used,
followed by the crystal structure file, then the PXRD data file and the indexed unit cell dimensions (a, b, c,
alpha, beta, gamma – in order).
~~~
trick compare PROGST10.cif PROGST-PXRD.xy 10.3741 12.6059 13.8464 90 90.268 90
~~~
The VC-xPWDF value is given at the end of the output `+ FINAL Diff = <value>`.

### Plotting PXRD overlays
In order to ensure a matching structure, plotting the overlay of the experimental data and simulated powder
diffractogram of the best (lowest VC-xPWDF score) crystal structure is recommended. If you have gnuplot
installed, running the [vc-xpwdf-plot.sh](/assets/critic2/example_13_01/vc-xpwdf-plot.sh) script from the
Linux command line will perform the VC-xPWDF comparison,
generate the simulated powder pattern from the distorted structure, and plot the data for you.
Run with the arguments requested, eg:
~~~
bash vc-xpwdf-plot.sh PROGST10-PXRD PROGST10.cif PROGST-PXRD.xy 10.3741 12.6059 13.8464 90 90.268 90
~~~
to yield the following image in `.pdf` format.

<figure style="width: 95%" class="align-center">
  <img src="{{ site.url }}{{ site.baseurl }}/assets/critic2/example_13_01/PROGST10-overlay.png" alt="PROGST10-PXRD overlay">
</figure>

## Example files package

Files: [example_13_01.tar.xz](/assets/critic2/example_13_01/example_13_01.tar.xz).

## Manual pages

- Loading [crystal structures](/critic2/manual/crystal/#c2-crystal)

- Simulating powder diffractograms from crystal structures [POWDER](/critic2/manual/powder)

- The [COMPARE](/critic2/manual/compare/) keyword

- The [COMPAREVC](/critic2/manual/comparevc/) keyword
